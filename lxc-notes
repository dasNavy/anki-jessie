=== host
apt install lxc

# We're going to skip any attempt at network isolation -- a separate
# network namespace also means a separate AF_UNIX abstract namespace,
# which defeats our attempts to connect to X as my X server appears
# not to listen on a file-namespace socket like /tmp/.X11-unix/X0,
# only the abstract-namespace socket with the same name.  Could try
# to get Xorg to listen there again, but other stuff like dbus or
# whatever else fcitx and friends might be relying on may also have
# similar trouble... just skip it.
#
# See also
# https://www.stgraber.org/2016/03/19/lxd-2-0-your-first-lxd-container-312/#comment-239404
#
# Useful general references:
#   https://wiki.archlinux.org/index.php/Linux_Containers
#   https://wiki.debian.org/LXC

lxc-create -n anki -t debian -- -r jessie
# Stick `lxc.network.type = none` in the config file.
lxc-start -n anki
lxc-attach -n anki

# Also set up bind mounts, for X and for Anki data
# TODO copy in here

=== setup in container

apt update
# TODO this has ibus stuff, redundant
apt install -y anki dbus-x11 fonts-vlgothic ibus-mozc locales x11-xkb-utils
# TODO get fcitx working
apt install -y fcitx
im-config -n fcitx  # TODO not certain this was needed
echo "en_US.UTF-8 UTF-8" >> /etc/locale.gen && locale-gen
ln -nsf /usr/share/zoneinfo/America/Los_Angeles /etc/localtime
useradd --create-home anki

== run

service lxc-net restart  # TODO fix this to work at startup
lxc-start -n anki

# On the need for QT_X11_NO_MITSHM=1 , see
#   http://forums.debian.net/viewtopic.php?f=30&t=105505&start=15
lxc-attach -n anki \
  --clear-env --keep-var DISPLAY --keep-var LANG --keep-var XMODIFIERS \
  -- su --login anki --command \
  'QT_X11_NO_MITSHM=1 anki'

# ibus-daemon -xd && anki'
#  -v LANG=en_US.UTF-8 \
#  -v XMODIFIERS=@im=ibus \
